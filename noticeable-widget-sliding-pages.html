<!--
@license
Copyright (c) 2017 Noticeable.io. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">

<dom-module id="noticeable-widget-sliding-pages">
    <template>

        <style>
            :host {
                display: block;
                position: relative;
                overflow: hidden;
            }

            div > ::slotted(:not([selected])) {
                display: none;
            }

        </style>

        <div>
            <slot></slot>
        </div>

    </template>

    <script>
        /**
         * `noticeable-widget-sliding-pages` enables page sliding.
         *
         * Third party developers should not have to deal with this component.
         *
         * @polymer
         * @customElement
         */
        class NoticeableWidgetSlidingPages extends Polymer.Element {

            static get is() {
                return 'noticeable-widget-sliding-pages';
            }

            static get properties() {
                return {
                    selected: {
                        observer: '_selectedChanged',
                        type: Object
                    }
                };
            }

            ready() {
                super.ready();
                requestAnimationFrame(this._installListeners.bind(this));
            }

            connectedCallback() {
                super.connectedCallback();

                this.shadowRoot.addEventListener('slotchange', this._resetSelected.bind(this));
                this._resetSelected();
            }

            next() {
                const elem = this.selected && this.selected.nextElementSibling;
                if (elem) {
                    // Setup transition start state
                    const oldSelected = this.selected;
                    this._translateX(oldSelected, 0);
                    this._translateX(elem, this.offsetWidth);

                    // Start the transition
                    this.selected = elem;
                    this._translateX(oldSelected, -this.offsetWidth, true /* transition */);
                    this._translateX(elem, 0, true /* transition */);
                }
            }

            previous() {
                const elem = this.selected && this.selected.previousElementSibling;
                if (elem) {
                    // Setup transition start state
                    const oldSelected = this.selected;
                    this._translateX(oldSelected, 0);
                    this._translateX(elem, -this.offsetWidth);

                    // Start the transition
                    this.selected = elem;
                    this._translateX(oldSelected, this.offsetWidth, false /* transition */);
                    this._translateX(elem, 0, true /* transition */);
                }
            }

            reset() {
                this.selected = this.firstElementChild;
            }

            _installListeners() {
                this.addEventListener('transitionend', this._resetChildrenStyles.bind(this));
            }

            _resetChildrenStyles() {
                let elem = this.firstElementChild;
                while (elem) {
                    elem.style.display = '';
                    elem.style.transition = '';
                    elem.style.transform = '';
                    elem = elem.nextElementSibling;
                }

                /**
                 * Fired when the active page changes.
                 * @event page-change
                 */
                this.dispatchEvent(new CustomEvent('page-change'));
            }

            _resetSelected() {
                if (!this.selected || this.selected.parentElement !== this) {
                    this.selected = this.firstElementChild;
                }
            }

            _selectedChanged(selected, oldSelected) {
                if (oldSelected) {
                    oldSelected.removeAttribute('selected');
                }

                if (selected) {
                    selected.setAttribute('selected', '');
                }
            }

            _translateX(elem, x, transition) {
                elem.style.display = 'block';
                elem.style.transition = transition ? 'transform 0.3s' : '';
                elem.style.transform = 'translate3d(' + x + 'px, 0, 0)';
            }

        }

        window.customElements.define(NoticeableWidgetSlidingPages.is, NoticeableWidgetSlidingPages);
    </script>
</dom-module>
